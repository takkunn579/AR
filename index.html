<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Photo Booth</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚ˆã‚Šæ–°ã—ãå®‰å®šã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–° -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <!-- ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ï¼ˆãƒ”ãƒ³ãƒæ“ä½œãªã©ï¼‰ç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://raw.githack.com/fcor/arjs-gestures/master/dist/gestures.js"></script>

    <style>
        /* æ’®å½±å¾Œã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #preview {
            /* æœ€åˆã¯éè¡¨ç¤ºã«ã—ã¦ãŠã */
            display: none; 
            
            /* ç”»é¢å…¨ä½“ã‚’è¦†ã†é»’ã„åŠé€æ˜ã®èƒŒæ™¯ */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 10000; /* å¸¸ã«æœ€å‰é¢ã«è¡¨ç¤º */

            /* ä¸­ã®è¦ç´ ã‚’ä¸­å¤®ã«é…ç½® */
            justify-content: center;
            align-items: center;
            flex-direction: column; /* è¦ç´ ã‚’ç¸¦ã«ä¸¦ã¹ã‚‹ */
        }

        /* æ’®å½±ã—ãŸç”»åƒã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #preview img {
            max-width: 90%; /* ç”»é¢å¹…ã®90%ã‚’æœ€å¤§å¹…ã« */
            max-height: 70%; /* ç”»é¢é«˜ã•ã®70%ã‚’æœ€å¤§é«˜ã« */
            border: 2px solid white;
            border-radius: 8px;
        }

        /* æ“ä½œæ¡ˆå†…ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
        #preview p {
            color: white;
            font-size: 18px;
            font-family: sans-serif;
            margin-top: 20px;
            font-weight: bold;
            text-align: center;
            padding: 0 20px;
        }

        /* é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #closeBtn {
            margin-top: 15px;
            padding: 12px 25px;
            font-size: 16px;
            background-color: #333;
            color: white;
            border: 1px solid white;
            border-radius: 20px;
            cursor: pointer;
        }

        /* æ’®å½±ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #captureBtn {
            position: absolute;
            bottom: 30px; /* ä½ç½®ã‚’ä¸‹ã«å¤‰æ›´ */
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            padding: 0;
            width: 70px; /* å††å½¢ã«ã™ã‚‹ */
            height: 70px;
            border-radius: 50%;
            font-size: 30px;
            background-color: white;
            border: 5px solid rgba(0, 0, 0, 0.3);
            box-sizing: border-box;
        }
    </style>
</head>

<body style="margin: 0; overflow: hidden;">
    <!-- ğŸ“· æ’®å½±ãƒœã‚¿ãƒ³ -->
    <button id="captureBtn">ğŸ“·</button>

    <!-- æ’®å½±ã—ãŸç”»åƒã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã™ã‚‹ãŸã‚ã®é ˜åŸŸ -->
    <div id="preview">
        <img id="previewImage" src="" alt="ã‚­ãƒ£ãƒ—ãƒãƒ£ç”»åƒ">
        <p id="previewText">ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„</p>
        <button id="closeBtn">é–‰ã˜ã‚‹</button>
    </div>

    <!-- ARã‚·ãƒ¼ãƒ³ -->
    <a-scene
        vr-mode-ui="enabled: false;"
        loading-screen="enabled: false;"
        renderer="logarithmicDepthBuffer: true; antialias: true; colorManagement: true; preserveDrawingBuffer: true;"
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
        embedded
        gesture-detector
        <!-- å‚è€ƒã‚³ãƒ¼ãƒ‰ã®æ–¹å¼ã‚’ä½¿ã†ãŸã‚ã€A-Frameã®screenshotæ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ– -->
        screenshot
    >
        <a-assets>
             <!-- è¤‡æ•°ãƒ¢ãƒ‡ãƒ« -->
             <a-asset-item id="model1" src="assets/model1.glb"></a-asset-item>
             <a-asset-item id="model2" src="assets/model2.glb"></a-asset-item>
             <a-asset-item id="model3" src="assets/model3.glb"></a-asset-item>
        </a-assets>

        <!-- ãƒãƒ¼ã‚«ãƒ¼1 â†’ model1 -->
        <a-marker type="pattern" url="assets/marker1.patt">
             <!-- åº§æ¨™ç³»ã‚’è£œæ­£ã™ã‚‹ãŸã‚ã®è¦ªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ -->
             <a-entity rotation="-90 0 0">
                <a-entity gltf-model="#model1" scale="0.5 0.5 0.5" position="0 0.5 0" gesture-handler></a-entity>
             </a-entity>
        </a-marker>

        <!-- ãƒãƒ¼ã‚«ãƒ¼2 â†’ model2 -->
        <a-marker type="pattern" url="assets/marker2.patt">
             <!-- åº§æ¨™ç³»ã‚’è£œæ­£ã™ã‚‹ãŸã‚ã®è¦ªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ -->
             <a-entity rotation="-90 0 0">
                <a-entity gltf-model="#model2" scale="0.5 0.5 0.5" position="0 0.5 0" gesture-handler></a-entity>
             </a-entity>
        </a-marker>

        <!-- ãƒãƒ¼ã‚«ãƒ¼3 â†’ model3 -->
        <a-marker type="pattern" url="assets/marker3.patt">
             <!-- åº§æ¨™ç³»ã‚’è£œæ­£ã™ã‚‹ãŸã‚ã®è¦ªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ -->
             <a-entity rotation="-90 0 0">
                <a-entity gltf-model="#model3" scale="0.5 0.5 0.5" position="0 0.5 0" gesture-handler></a-entity>
             </a-entity>
        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <!-- æ’®å½±ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script>
        const sceneEl = document.querySelector("a-scene");
        const captureBtn = document.getElementById("captureBtn");
        const preview = document.getElementById("preview");
        const previewImage = document.getElementById("previewImage");
        const previewText = document.getElementById("previewText");
        const closeBtn = document.getElementById("closeBtn");

        captureBtn.addEventListener("click", () => {
            try {
                // ARã®æ˜ åƒã¨3Dãƒ¢ãƒ‡ãƒ«ã‚’åˆæˆã—ã¦æ’®å½±ã™ã‚‹
                const video = document.querySelector('video'); // AR.jsãŒç”Ÿæˆã™ã‚‹videoè¦ç´ 
                
                // A-Frameã®screenshotã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ã£ã¦3Dãƒ¢ãƒ‡ãƒ«ãŒæç”»ã•ã‚ŒãŸcanvasã‚’å–å¾—
                const aSceneCanvas = sceneEl.components.screenshot.getCanvas("perspective");

                if (!video || !aSceneCanvas) {
                    console.error('ARã®æ˜ åƒã¾ãŸã¯3Dã‚·ãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                    // ã€ä¿®æ­£ã€‘ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤º
                    previewText.textContent = "ã‚¨ãƒ©ãƒ¼: ARã‚·ãƒ¼ãƒ³ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚";
                    previewImage.style.display = 'none';
                    preview.style.display = "flex";
                    return;
                }

                const videoWidth = video.videoWidth;
                const videoHeight = video.videoHeight;

                // ã€ä¿®æ­£ã€‘ã‚«ãƒ¡ãƒ©æ˜ åƒãŒæº–å‚™ã§ãã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (videoWidth === 0 || videoHeight === 0) {
                    console.error("ãƒ“ãƒ‡ã‚ªã®è§£åƒåº¦ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚ã‚«ãƒ¡ãƒ©ãŒæœ‰åŠ¹ã«ãªã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚");
                    // ã€ä¿®æ­£ã€‘æº–å‚™ä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤º
                    previewText.textContent = "ã‚«ãƒ¡ãƒ©ã®æº–å‚™ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
                    previewImage.style.display = 'none';
                    preview.style.display = "flex";
                    return;
                }

                // æœ€çµ‚çš„ãªç”»åƒã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ä¸€æ™‚çš„ãªcanvasã‚’ä½œæˆ
                const compositeCanvas = document.createElement('canvas');
                const ctx = compositeCanvas.getContext('2d');

                // canvasã®ã‚µã‚¤ã‚ºã‚’ã‚«ãƒ¡ãƒ©æ˜ åƒã®å®Ÿéš›ã®è§£åƒåº¦ã«åˆã‚ã›ã‚‹
                compositeCanvas.width = videoWidth;
                compositeCanvas.height = videoHeight;

                // 1. èƒŒæ™¯ã¨ã—ã¦ã€ç¾åœ¨ã®ã‚«ãƒ¡ãƒ©æ˜ åƒã‚’æç”»
                ctx.drawImage(video, 0, 0, videoWidth, videoHeight);
                
                // 2. ãã®ä¸Šã«3Dãƒ¢ãƒ‡ãƒ«(A-Frame canvas)ã‚’é‡ã­ã‚‹
                const sceneAspectRatio = aSceneCanvas.width / aSceneCanvas.height;
                const videoAspectRatio = videoWidth / videoHeight;

                let drawWidth, drawHeight, offsetX, offsetY;

                if (sceneAspectRatio > videoAspectRatio) {
                    // ã‚·ãƒ¼ãƒ³ã®æ–¹ãŒæ¨ªé•· â†’ æ¨ªã‚’åŸºæº–ã«ç¸®å°
                    drawWidth = videoWidth;
                    drawHeight = videoWidth / sceneAspectRatio;
                    offsetX = 0;
                    offsetY = (videoHeight - drawHeight) / 2;
                } else {
                    // ã‚·ãƒ¼ãƒ³ã®æ–¹ãŒç¸¦é•· â†’ ç¸¦ã‚’åŸºæº–ã«ç¸®å°
                    drawHeight = videoHeight;
                    drawWidth = videoHeight * sceneAspectRatio;
                    offsetX = (videoWidth - drawWidth) / 2;
                    offsetY = 0;
                }

                // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ã¦ä¸­å¤®ã«æç”»
                ctx.drawImage(aSceneCanvas, offsetX, offsetY, drawWidth, drawHeight);
                
                // 3. åˆæˆã—ãŸcanvasã‹ã‚‰ç”»åƒãƒ‡ãƒ¼ã‚¿(DataURL)ã‚’ç”Ÿæˆ
                const dataURL = compositeCanvas.toDataURL('image/png');

                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®imgã‚¿ã‚°ã«ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
                previewImage.src = dataURL;
                // ã€ä¿®æ­£ã€‘ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã®éš›ã«ã€å¿…ãšç”»åƒã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’æ­£ã—ã„çŠ¶æ…‹ã«æˆ»ã™
                previewImage.style.display = 'block';
                previewText.textContent = "ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„";
                
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã‚’è¡¨ç¤º
                preview.style.display = "flex";
            } catch (error) {
                console.error("æ’®å½±ä¸­ã«äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
                // ã€ä¿®æ­£ã€‘äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤º
                previewText.textContent = "æ’®å½±ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚";
                previewImage.style.display = 'none';
                preview.style.display = "flex";
            }
        });

        // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        closeBtn.addEventListener("click", () => {
            preview.style.display = "none";
        });
    </script>
</body>
</html>

